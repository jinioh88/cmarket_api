# 비밀번호 재설정 API 문서

> 반려동물 용품 중고거래 서비스 - **비밀번호 재설정** API 문서

본 문서는 비밀번호 재설정 관련 API에 대한 상세 설명을 제공합니다.

---

## 목차

- [공통 사항](#공통-사항)
- [비밀번호 재설정 인증코드 발송](#1-비밀번호-재설정-인증코드-발송)
- [비밀번호 재설정](#2-비밀번호-재설정)
- [회원 탈퇴](#3-회원-탈퇴)

---

## 공통 사항

### Base URL
```
http://localhost:8080
```

### 공통 응답 형식

#### 성공 응답
```json
{
  "code": {
    "code": 200,
    "message": "성공"
  },
  "message": "성공",
  "data": { ... }
}
```

#### 에러 응답
```json
{
  "code": {
    "code": 400,
    "message": "잘못된 요청"
  },
  "message": "에러 메시지",
  "traceId": "e1e4456f40d648c7a24fc7d5cd85e4af",
  "timestamp": "2025-11-14T15:45:00"
}
```

### HTTP 상태 코드

| 코드 | 설명 |
|------|------|
| 200 | 성공 |
| 400 | 잘못된 요청 (입력값 검증 실패) |
| 401 | 인증 필요 |
| 500 | 서버 오류 |

### 공통 헤더

| 헤더명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| Content-Type | String | 예 | application/json |
| Authorization | String | 인증 필요 시 | `Bearer <Access Token>` 형식 |
| X-Trace-Id | String | 아니오 | 요청 추적 ID (자동 생성) |

---

## 1. 비밀번호 재설정 인증코드 발송

비밀번호를 잊었을 때, 이메일로 인증코드를 발송합니다.

### 엔드포인트

```
POST /api/auth/password/reset/send
```

### 설명

- 사용자가 비밀번호를 잊었을 때, 등록된 이메일 주소로 6자리 랜덤 인증코드를 발송합니다.
- 인증코드는 5분간 유효합니다.
- 같은 이메일로 재요청 시 기존 인증코드는 삭제되고 새로운 인증코드가 발송됩니다.
- **소셜 로그인 사용자는 비밀번호 재설정이 불가능합니다** (일반 회원가입 사용자만 가능).
- 등록되지 않은 이메일로 요청 시 에러가 발생합니다.
- 개발 환경에서는 실제 이메일 발송 없이 서버 로그에 인증코드가 출력됩니다.

### Request Body

| 필드명 | 타입 | 필수 | 설명 | 제약조건 |
|--------|------|------|------|----------|
| email | String | 예 | 이메일 주소 | 이메일 형식, 최대 100자 |

### Request Body 예시

```json
{
  "email": "user@example.com"
}
```

### Response

#### 성공 응답 (200 OK)

| 필드명 | 타입 | 설명 |
|--------|------|------|
| code | Object | 응답 코드 정보 |
| code.code | Integer | HTTP 상태 코드 (200) |
| code.message | String | 응답 메시지 ("성공") |
| message | String | 응답 메시지 ("성공") |
| data | String | 응답 데이터 ("인증 번호를 발송했습니다.") |

#### 성공 응답 예시

```json
{
  "code": {
    "code": 200,
    "message": "성공"
  },
  "message": "성공",
  "data": "인증 번호를 발송했습니다."
}
```

### 에러 응답

#### 400 Bad Request - 입력값 검증 실패

**에러 메시지 예시:**
- `"이메일은 필수입니다."` - email 필드가 비어있을 때
- `"올바른 이메일 형식이 아닙니다."` - 이메일 형식이 올바르지 않을 때

#### 400 Bad Request - 비즈니스 로직 검증 실패

**에러 메시지 예시:**
- `"등록되지 않은 이메일입니다."` - 해당 이메일로 가입된 사용자가 없을 때
- `"소셜 로그인 사용자는 비밀번호 재설정이 불가능합니다."` - 구글/카카오로 가입한 사용자일 때

#### 에러 응답 예시

```json
{
  "code": {
    "code": 400,
    "message": "잘못된 요청"
  },
  "message": "등록되지 않은 이메일입니다.",
  "traceId": "e1e4456f40d648c7a24fc7d5cd85e4af",
  "timestamp": "2025-11-14T15:45:00"
}
```

### 주의사항

1. **소셜 로그인 사용자**: 구글/카카오로 가입한 사용자는 비밀번호 재설정이 불가능합니다. 소셜 로그인 제공자에서 비밀번호를 재설정해야 합니다.
2. **인증코드 유효 시간**: 인증코드는 발송 후 5분간만 유효합니다.
3. **인증코드 검증**: 발송된 인증코드는 `/api/auth/email/verification/verify` API를 통해 먼저 검증해야 합니다.
4. **재발송**: 같은 이메일로 재요청 시 기존 인증코드는 무효화되고 새로운 인증코드가 발송됩니다.

---

## 2. 비밀번호 재설정

이메일 인증이 완료된 상태에서 비밀번호를 변경합니다.

### 엔드포인트

```
PATCH /api/auth/password/reset
```

### 설명

- 클라이언트에서 이미 인증코드 검증을 완료한 후 호출됩니다.
- 이메일 인증이 완료된 상태에서만 비밀번호를 변경할 수 있습니다.
- 새 비밀번호와 비밀번호 확인이 일치해야 합니다.
- **소셜 로그인 사용자는 비밀번호 재설정이 불가능합니다** (일반 회원가입 사용자만 가능).
- 비밀번호 변경 후에는 새로운 비밀번호로 로그인해야 합니다.

### 동작 흐름

1. **인증코드 발송**: `/api/auth/password/reset/send`로 인증코드 발송
2. **인증코드 검증**: `/api/auth/email/verification/verify`로 인증코드 검증 (서버에서 `verifiedAt` 설정)
3. **비밀번호 변경**: `/api/auth/password/reset`로 비밀번호 변경 (서버에서 인증 완료 여부 확인)

### Request Body

| 필드명 | 타입 | 필수 | 설명 | 제약조건 |
|--------|------|------|------|----------|
| email | String | 예 | 이메일 주소 | 이메일 형식, 최대 100자 |
| newPassword | String | 예 | 새 비밀번호 | 필수, 프론트엔드에서 유효성 검증 |
| confirmPassword | String | 예 | 비밀번호 확인 | 필수, newPassword와 일치해야 함 |

### Request Body 예시

```json
{
  "email": "user@example.com",
  "newPassword": "NewPassword123!",
  "confirmPassword": "NewPassword123!"
}
```

### Response

#### 성공 응답 (200 OK)

| 필드명 | 타입 | 설명 |
|--------|------|------|
| code | Object | 응답 코드 정보 |
| code.code | Integer | HTTP 상태 코드 (200) |
| code.message | String | 응답 메시지 ("성공") |
| message | String | 응답 메시지 ("성공") |
| data | String | 응답 데이터 ("비밀번호가 변경되었습니다.") |

#### 성공 응답 예시

```json
{
  "code": {
    "code": 200,
    "message": "성공"
  },
  "message": "성공",
  "data": "비밀번호가 변경되었습니다."
}
```

### 에러 응답

#### 400 Bad Request - 입력값 검증 실패

**에러 메시지 예시:**
- `"이메일은 필수입니다."` - email 필드가 비어있을 때
- `"올바른 이메일 형식이 아닙니다."` - 이메일 형식이 올바르지 않을 때
- `"새 비밀번호는 필수입니다."` - newPassword 필드가 비어있을 때
- `"비밀번호 확인은 필수입니다."` - confirmPassword 필드가 비어있을 때
- `"비밀번호가 일치하지 않습니다."` - newPassword와 confirmPassword가 일치하지 않을 때

#### 400 Bad Request - 비즈니스 로직 검증 실패

**에러 메시지 예시:**
- `"등록되지 않은 이메일입니다."` - 해당 이메일로 가입된 사용자가 없을 때
- `"소셜 로그인 사용자는 비밀번호 재설정이 불가능합니다."` - 구글/카카오로 가입한 사용자일 때
- `"이메일 인증이 완료되지 않았습니다. 인증코드를 먼저 확인해주세요."` - 인증코드 검증을 완료하지 않았을 때

#### 에러 응답 예시

```json
{
  "code": {
    "code": 400,
    "message": "잘못된 요청"
  },
  "message": "이메일 인증이 완료되지 않았습니다. 인증코드를 먼저 확인해주세요.",
  "traceId": "e1e4456f40d648c7a24fc7d5cd85e4af",
  "timestamp": "2025-11-14T15:45:00"
}
```

### 주의사항

1. **인증코드 검증 필수**: 비밀번호 변경 전에 반드시 `/api/auth/email/verification/verify` API를 통해 인증코드를 검증해야 합니다.
2. **소셜 로그인 사용자**: 구글/카카오로 가입한 사용자는 비밀번호 재설정이 불가능합니다.
3. **비밀번호 일치**: `newPassword`와 `confirmPassword`가 일치해야 합니다.
4. **비밀번호 유효성**: 비밀번호 유효성 검증은 프론트엔드에서 처리합니다.
5. **로그인 필요**: 비밀번호 변경 후에는 새로운 비밀번호로 다시 로그인해야 합니다.

---

## 3. 회원 탈퇴

현재 로그인한 사용자의 계정을 소프트 삭제 처리합니다.

### 엔드포인트

```
DELETE /api/auth/withdraw
```

### 설명

- 현재 로그인한 사용자의 계정을 소프트 삭제 처리합니다.
- 탈퇴 사유와 상세 사유를 저장합니다.
- 탈퇴 즉시 로그아웃 처리됩니다 (토큰이 블랙리스트에 추가됨).
- 탈퇴 후에는 해당 계정으로 로그인할 수 없습니다.
- **인증이 필수**입니다 (로그인한 사용자만 탈퇴 가능).

### Request Headers

| 헤더명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| Authorization | String | 예 | `Bearer <Access Token>` 형식 |
| Content-Type | String | 예 | application/json |

### Request Body

| 필드명 | 타입 | 필수 | 설명 | 제약조건 |
|--------|------|------|------|----------|
| reason | Enum | 예 | 탈퇴 사유 | SERVICE_DISSATISFACTION, PRIVACY_CONCERN, LOW_USAGE, COMPETITOR, OTHER 중 하나 |
| detailReason | String | 아니오 | 탈퇴 상세 사유 | 2-500자 (선택 사항) |

### 탈퇴 사유 (WithdrawalReasonType)

| 값 | 설명 |
|----|------|
| SERVICE_DISSATISFACTION | 서비스 불만족 |
| PRIVACY_CONCERN | 개인정보 우려 |
| LOW_USAGE | 사용 빈도 낮음 |
| COMPETITOR | 경쟁 서비스 이용 |
| OTHER | 기타 |

### Request Body 예시

```json
{
  "reason": "SERVICE_DISSATISFACTION",
  "detailReason": "원하는 기능이 부족합니다."
}
```

또는 상세 사유 없이:

```json
{
  "reason": "LOW_USAGE"
}
```

### Response

#### 성공 응답 (200 OK)

| 필드명 | 타입 | 설명 |
|--------|------|------|
| code | Object | 응답 코드 정보 |
| code.code | Integer | HTTP 상태 코드 (200) |
| code.message | String | 응답 메시지 ("성공") |
| message | String | 응답 메시지 ("성공") |
| data | String | 응답 데이터 ("회원 탈퇴가 완료되었습니다.") |

#### 성공 응답 예시

```json
{
  "code": {
    "code": 200,
    "message": "성공"
  },
  "message": "성공",
  "data": "회원 탈퇴가 완료되었습니다."
}
```

### 에러 응답

#### 400 Bad Request - 입력값 검증 실패

**에러 메시지 예시:**
- `"탈퇴 사유는 필수입니다."` - reason 필드가 비어있을 때
- `"탈퇴 상세 사유는 2자 이상 500자 이하여야 합니다."` - detailReason이 2자 미만이거나 500자 초과일 때

#### 400 Bad Request - 비즈니스 로직 검증 실패

**에러 메시지 예시:**
- `"사용자를 찾을 수 없습니다."` - 해당 이메일로 가입된 사용자가 없을 때
- `"이미 탈퇴한 사용자입니다."` - 이미 탈퇴 처리된 사용자일 때

#### 401 Unauthorized - 인증 실패

**에러 메시지 예시:**
- 인증 토큰이 없거나 유효하지 않을 때
- 토큰이 블랙리스트에 등록되어 있을 때

#### 에러 응답 예시

```json
{
  "code": {
    "code": 400,
    "message": "잘못된 요청"
  },
  "message": "사용자를 찾을 수 없습니다.",
  "traceId": "e1e4456f40d648c7a24fc7d5cd85e4af",
  "timestamp": "2025-11-14T15:45:00"
}
```

### 주의사항

1. **인증 필수**: 회원 탈퇴는 로그인한 사용자만 가능합니다. Authorization 헤더에 유효한 Access Token이 필요합니다.
2. **즉시 로그아웃**: 탈퇴 처리와 동시에 토큰이 블랙리스트에 추가되어 즉시 로그아웃 처리됩니다.
3. **탈퇴 사유 필수**: `reason` 필드는 반드시 선택해야 합니다. 5가지 사유 중 하나를 선택해야 합니다.
4. **상세 사유 선택**: `detailReason`은 선택 사항이지만, 입력 시 2자 이상 500자 이하여야 합니다.
5. **복구 불가**: 탈퇴 처리된 계정은 복구할 수 없습니다. 탈퇴 전에 신중히 결정하세요.
6. **소프트 삭제**: 계정은 완전히 삭제되지 않고 소프트 삭제 처리됩니다 (`deletedAt` 필드 설정).
7. **진행 중인 거래**: 향후 진행 중인 거래가 있는 경우 탈퇴가 제한될 수 있습니다 (현재는 구현되지 않음).

---

## 업데이트 이력

| 날짜 | 버전 | 변경 내용 |
|------|------|----------|
| 2025-11-14 | 1.0.0 | 초기 문서 작성 (비밀번호 재설정 API) |
| 2025-11-14 | 1.1.0 | 회원 탈퇴 API 추가 |

