# 이미지 리사이징 및 성능 개선 할일

> 이미지 업로드 시 리사이징/WebP 변환 및 CloudFront CDN 도입 작업 목록

---

## 개요

현재 이미지 업로드 API는 원본 이미지를 그대로 S3에 업로드하고 있습니다.
이를 개선하여 이미지 성능을 향상시키고 사용자 경험을 개선합니다.

**현재 구조:**
- `ImageUploadService`: 원본 이미지를 S3에 직접 업로드
- S3 URL 반환: `https://{bucket-name}.s3.{region}.amazonaws.com/{key}`
- 이미지 최적화 없음 (원본 크기 그대로 저장)
- CDN 미사용 (S3 직접 접근)

**변경 후 구조:**
- `ImageUploadService`: 업로드 시 리사이징 및 WebP 변환 수행
- 원본 + 썸네일 버전 생성 및 업로드
- CloudFront CDN을 통한 이미지 제공
- 캐싱 최적화로 로딩 속도 개선

---

## 개선 효과

### 1. 서버 사이드 이미지 전처리
- **파일 크기 감소**: 리사이징으로 60-80% 파일 크기 감소
- **WebP 변환**: 추가 25-35% 파일 크기 감소
- **로딩 속도 개선**: 초기 로딩 시간 70-80% 단축
- **대역폭 절감**: 데이터 전송 비용 감소

### 2. CloudFront CDN 도입
- **전 세계 엣지 서버**: 사용자 위치에 가까운 서버에서 제공
- **응답 속도 개선**: 지연 시간 50-70% 감소
- **S3 비용 절감**: 데이터 전송 비용 감소
- **HTTPS 자동 지원**: 보안 강화

---

## 사용자가 직접 해야 할 작업

### Step 1: CloudFront 배포 생성

#### 1-1. CloudFront 배포 생성
- **작업 내용**:
  - AWS 콘솔에 로그인
  - CloudFront 서비스로 이동
  - "배포 생성" 클릭
  - **Origin 설정**:
    - Origin Domain: S3 버킷 선택 (예: `cmarket-images.s3.ap-northeast-2.amazonaws.com`)
    - Origin Path: 비워둠 (전체 버킷 사용)
    - Origin Access: "Origin access control settings (recommended)" 선택
    - Origin Access Control: 새로 생성 또는 기존 것 선택
      - 이름: `cmarket-images-oac`
      - Signing behavior: "Sign requests (recommended)"
      - Origin type: "S3"
  - **Default cache behavior 설정**:
    - Viewer protocol policy: "Redirect HTTP to HTTPS" (보안 강화)
    - Allowed HTTP methods: "GET, HEAD, OPTIONS"
    - Cache policy: "CachingOptimized" 선택
      - 또는 Custom policy 생성:
        - Cache key settings: Query strings 없음, Headers 없음
        - TTL settings:
          - Default TTL: 86400 (1일)
          - Maximum TTL: 31536000 (1년)
          - Minimum TTL: 0
    - Compress objects automatically: ✅ 체크 (Gzip 압축)
  - **Distribution settings**:
    - Price class: "Use only North America and Europe" (비용 절감) 또는 "Use all edge locations" (최고 성능)
    - Alternate domain names (CNAMEs): 필요 시 도메인 추가 (예: `images.cmarket.com`)
    - SSL certificate: 기본 CloudFront 인증서 사용 또는 ACM 인증서 선택
    - Default root object: 비워둠
    - Logging: 필요 시 활성화
  - "배포 생성" 클릭
  - ⚠️ **배포 완료까지 10-15분 소요**

#### 1-2. S3 버킷 정책 업데이트 (Origin Access Control)
- **작업 내용**:
  - S3 버킷 선택 → 권한 탭 → 버킷 정책 편집
  - CloudFront에서 생성한 Origin Access Control의 ARN 확인
  - 기존 퍼블릭 읽기 정책을 OAC 정책으로 교체:
    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "AllowCloudFrontServicePrincipal",
          "Effect": "Allow",
          "Principal": {
            "Service": "cloudfront.amazonaws.com"
          },
          "Action": "s3:GetObject",
          "Resource": "arn:aws:s3:::cmarket-images/*",
          "Condition": {
            "StringEquals": {
              "AWS:SourceArn": "arn:aws:cloudfront::ACCOUNT_ID:distribution/DISTRIBUTION_ID"
            }
          }
        }
      ]
    }
    ```
  - `ACCOUNT_ID`: AWS 계정 ID
  - `DISTRIBUTION_ID`: CloudFront 배포 ID
  - ⚠️ **중요**: CloudFront 배포 생성 후 배포 ID를 확인하여 정책에 추가해야 합니다.
  - "저장" 클릭
  - ⚠️ **보안 개선**: 이제 S3 버킷은 CloudFront를 통해서만 접근 가능합니다.

#### 1-3. CloudFront 도메인 확인
- **작업 내용**:
  - CloudFront 배포 목록에서 생성한 배포 선택
  - "일반" 탭에서 "도메인 이름" 확인
  - 예: `d1234567890abc.cloudfront.net`
  - 이 도메인을 애플리케이션 설정에 추가해야 합니다.

---

## AI에게 위임할 수 있는 작업

### Step 2: 이미지 리사이징 라이브러리 의존성 추가

#### 2-1. 이미지 처리 라이브러리 추가
- **작업 내용**:
  - `service/cmarket/build.gradle`에 이미지 처리 라이브러리 의존성 추가
  - **옵션 1: Scrimage** (권장 - WebP 지원)
    ```gradle
    implementation 'com.sksamuel.scrimage:scrimage-core:4.1.0'
    implementation 'com.sksamuel.scrimage:scrimage-formats-extra:4.1.0' // WebP 지원
    ```
  - **옵션 2: Thumbnailator** (가볍고 간단)
    ```gradle
    implementation 'net.coobird:thumbnailator:0.4.20'
    ```
    - ⚠️ **주의**: Thumbnailator는 WebP를 직접 지원하지 않으므로, WebP 변환이 필요하면 Scrimage 사용 권장
- **출력물**:
  - `service/cmarket/build.gradle` 수정

---

### Step 3: 이미지 리사이징 서비스 구현

#### 3-1. 이미지 리사이징 유틸리티 클래스 생성
- **작업 내용**:
  - `ImageResizeService` 또는 `ImageOptimizationService` 생성
  - 리사이징 로직 구현:
    - **원본 이미지**: 최대 1920x1920px로 리사이징 (비율 유지)
    - **썸네일 이미지**: 300x300px로 리사이징 (비율 유지, 크롭 가능)
  - WebP 변환 로직 구현:
    - 원본 포맷이 JPEG/PNG인 경우 WebP로 변환
    - WebP 품질 설정: 85% (품질과 파일 크기 균형)
  - 이미지 압축 최적화
- **출력물**:
  - `service/cmarket/src/main/java/org/cmarket/cmarket/web/product/service/ImageResizeService.java` 생성

#### 3-2. 이미지 리사이징 설정 프로퍼티 추가
- **작업 내용**:
  - `application.properties`에 이미지 리사이징 설정 추가:
    ```properties
    # 이미지 리사이징 설정
    image.resize.enabled=true
    image.resize.original.max-width=1920
    image.resize.original.max-height=1920
    image.resize.thumbnail.width=300
    image.resize.thumbnail.height=300
    image.resize.webp.enabled=true
    image.resize.webp.quality=85
    ```
- **출력물**:
  - `service/cmarket/src/main/resources/application.properties` 수정
  - `service/cmarket/src/main/resources/application-prod.properties` 수정

---

### Step 4: ImageUploadService 수정

#### 4-1. 업로드 전 이미지 전처리 로직 추가
- **작업 내용**:
  - `ImageUploadService.uploadImages()` 메서드 수정
  - 업로드 전 이미지 리사이징 및 WebP 변환 수행:
    1. 원본 이미지 리사이징 (최대 1920x1920px)
    2. WebP 변환 (설정 활성화 시)
    3. 썸네일 생성 (300x300px)
    4. 원본 + 썸네일 모두 S3에 업로드
  - S3 키 구조:
    - 원본: `user/{userId}/{yyyy}/{MM}/{dd}/{uuid}.webp` (또는 원본 확장자)
    - 썸네일: `user/{userId}/{yyyy}/{MM}/{dd}/{uuid}_thumb.webp`
  - 반환 URL 구조:
    - 원본 URL과 썸네일 URL 모두 반환
    - 또는 원본만 반환하고 썸네일은 필요 시 별도 API로 제공
- **출력물**:
  - `service/cmarket/src/main/java/org/cmarket/cmarket/web/product/service/ImageUploadService.java` 수정

#### 4-2. S3 업로드 시 Cache-Control 메타데이터 추가
- **작업 내용**:
  - `PutObjectRequest`에 Cache-Control 헤더 추가
  - 원본 이미지: `public, max-age=31536000` (1년)
  - 썸네일: `public, max-age=31536000` (1년)
- **출력물**:
  - `ImageUploadService.java` 수정

---

### Step 5: CloudFront URL 사용하도록 수정

#### 5-1. CloudFront 도메인 설정 추가
- **작업 내용**:
  - `application.properties`에 CloudFront 도메인 설정 추가:
    ```properties
    # CloudFront 설정
    aws.cloudfront.domain=${CLOUDFRONT_DOMAIN:}
    aws.cloudfront.enabled=${CLOUDFRONT_ENABLED:false}
    ```
  - CloudFront 도메인이 설정되어 있으면 CloudFront URL 반환
  - 설정되어 있지 않으면 기존 S3 URL 반환 (하위 호환성)
- **출력물**:
  - `service/cmarket/src/main/resources/application.properties` 수정
  - `service/cmarket/src/main/resources/application-prod.properties` 수정

#### 5-2. ImageUploadService에서 CloudFront URL 생성
- **작업 내용**:
  - CloudFront 도메인이 설정되어 있으면 CloudFront URL 반환
  - URL 형식: `https://{cloudfront-domain}/{s3-key}`
  - 예: `https://d1234567890abc.cloudfront.net/user/1/2024/01/15/uuid.webp`
- **출력물**:
  - `ImageUploadService.java` 수정

---

### Step 6: 응답 DTO 수정 (선택사항)

#### 6-1. 이미지 URL 응답 구조 개선
- **작업 내용**:
  - 원본 URL과 썸네일 URL을 모두 반환하도록 DTO 수정
  - 또는 기존 구조 유지 (원본만 반환)
- **출력물**:
  - `ImageUploadResponse.java` 수정 (필요 시)

---

### Step 7: 테스트 및 검증

#### 7-1. 단위 테스트 작성
- **작업 내용**:
  - 이미지 리사이징 서비스 테스트
  - WebP 변환 테스트
  - 썸네일 생성 테스트
- **출력물**:
  - 테스트 코드 작성

#### 7-2. 통합 테스트
- **작업 내용**:
  - 실제 이미지 업로드 테스트
  - 리사이징 결과 확인
  - WebP 변환 결과 확인
  - CloudFront URL 접근 테스트
  - 파일 크기 비교 (원본 vs 리사이징 후)
- **검증 항목**:
  - ✅ 이미지 리사이징 성공
  - ✅ WebP 변환 성공
  - ✅ 썸네일 생성 성공
  - ✅ CloudFront URL 접근 가능
  - ✅ 파일 크기 감소 확인
  - ✅ 이미지 품질 확인
  - ✅ 에러 처리 동작 확인

---

## 구현 순서 요약

1. **사용자 작업**: CloudFront 배포 생성 및 S3 정책 업데이트 (Step 1)
   - CloudFront 배포 생성
   - S3 버킷 정책 업데이트
   - CloudFront 도메인 확인

2. **AI 작업**: 이미지 처리 라이브러리 의존성 추가 (Step 2)

3. **AI 작업**: 이미지 리사이징 서비스 구현 (Step 3)

4. **AI 작업**: ImageUploadService 수정 (Step 4)
   - 업로드 전 이미지 전처리
   - Cache-Control 메타데이터 추가

5. **AI 작업**: CloudFront URL 사용하도록 수정 (Step 5)

6. **AI 작업**: 응답 DTO 수정 (선택사항, Step 6)

7. **AI 작업**: 테스트 및 검증 (Step 7)

---

## 주의사항

### 성능
- **서버 리소스**: 이미지 리사이징은 CPU/메모리를 많이 사용합니다.
  - 대용량 이미지 처리 시 EC2 인스턴스 사양 확인
  - 필요 시 Lambda로 비동기 처리 고려
- **처리 시간**: 리사이징으로 인해 업로드 시간이 증가할 수 있습니다.
  - 사용자 경험을 위해 비동기 처리 고려
  - 또는 프론트엔드에서 업로드 전 리사이징 고려

### 비용
- **S3 스토리지**: 원본 + 썸네일로 저장 공간이 2배 증가
  - 필요 시 원본만 저장하고 썸네일은 요청 시 생성 고려
- **CloudFront**: 데이터 전송 비용 발생
  - 캐싱으로 인해 실제 비용은 낮을 수 있음
  - Price class 설정으로 비용 조절 가능

### 호환성
- **WebP 지원**: 모든 브라우저가 WebP를 지원하지 않을 수 있습니다.
  - User-Agent 확인 후 WebP/원본 포맷 선택
  - 또는 원본 포맷도 함께 저장
- **기존 이미지**: 기존에 업로드된 이미지는 리사이징되지 않습니다.
  - 필요 시 배치 작업으로 기존 이미지 리사이징 고려

### 보안
- **S3 버킷 접근**: CloudFront OAC 설정으로 S3 직접 접근 차단
- **이미지 검증**: 리사이징 과정에서도 파일 형식 검증 유지

---

## 참고 자료

### 라이브러리 문서
- [Scrimage GitHub](https://github.com/sksamuel/scrimage)
- [Thumbnailator GitHub](https://github.com/coobird/thumbnailator)

### AWS 문서
- [CloudFront 시작하기](https://docs.aws.amazon.com/cloudfront/latest/DeveloperGuide/GettingStarted.html)
- [CloudFront Origin Access Control](https://docs.aws.amazon.com/cloudfront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html)
- [S3 버킷 정책 예제](https://docs.aws.amazon.com/AmazonS3/latest/userguide/example-bucket-policies.html)

### 이미지 최적화 가이드
- [WebP 포맷 가이드](https://developers.google.com/speed/webp)
- [이미지 최적화 모범 사례](https://web.dev/fast/#optimize-your-images)

---

## 추가 개선 사항 (선택사항)

### Lambda 기반 비동기 처리
- 업로드는 원본만 저장
- Lambda 함수로 자동 리사이징 및 WebP 변환
- S3 이벤트 트리거 사용

### 동적 리사이징
- CloudFront + Lambda@Edge 사용
- 요청 시 필요한 크기로 동적 리사이징
- 쿼리 파라미터로 크기 지정 (예: `?w=300&h=300`)

### 이미지 포맷 자동 선택
- User-Agent 확인
- WebP 지원 브라우저: WebP 제공
- 미지원 브라우저: 원본 포맷 제공
