# Docker 배포 구현 할일

> Cmarket API를 Docker를 통해 로컬에 배포하기 위한 작업 목록

---

## 개요

본 문서는 Spring Boot API를 Docker를 통해 로컬에 배포하기 위한 단계별 작업을 정리한 것입니다.
**Spring Boot + Redis + H2 + SSL(HTTPS)** 환경을 구축합니다.

---

## 구현 순서

> ⚠️ **수동 작업 필수**: 아래 표시된 작업은 반드시 수동으로 수행해야 합니다.
> - 🔴 **Step 5-3**: 도메인 준비 및 DNS 설정 (외부 서비스 작업)
> - 🔴 **Step 5-4**: Nginx Proxy Manager 웹 UI 설정 (브라우저 작업)
> - 🔴 **Step 5-5**: 환경 변수에 실제 도메인 값 입력 (사용자 결정 필요)

> ✅ **자동화 가능**: 나머지 작업들은 자동화하여 처리할 수 있습니다.

### Step 1: Spring Boot 설정 파일 수정

#### 1-1. application.properties 수정
- **작업 내용**:
  - 도커 컨테이너 환경에 맞춰 DB와 Redis 연결 정보를 수정합니다.
  - H2 데이터베이스 경로를 컨테이너 외부 볼륨에 저장하도록 변경
  - Redis 호스트를 Docker Compose 서비스 이름으로 변경
  - 이미지 업로드 경로를 볼륨 마운트 경로로 변경
  - OAuth2 리다이렉트 URI와 이미지 서버 URL은 환경 변수로 관리하도록 변경
- **수정 대상 파일**:
  - `service/cmarket/src/main/resources/application.properties`
- **수정 내용**:
  ```properties
  # H2 데이터베이스 경로 변경 (도커 볼륨 마운트 경로)
  spring.datasource.url=jdbc:h2:file:/data/cmarket;DB_CLOSE_DELAY=-1
  
  # Redis 호스트 변경 (Docker Compose 서비스 이름)
  spring.data.redis.host=redis
  
  # 이미지 업로드 경로 (도커 볼륨 마운트 경로)
  app.image.upload-dir=/data/uploads/images
  
  # OAuth2 리다이렉트 URL (환경 변수로 관리, 기본값은 기존 값 유지)
  oauth2.redirect-uri=${OAUTH2_REDIRECT_URI:http://localhost:5173/oauth-redirect}
  
  # 이미지 서버 URL (환경 변수로 관리, 기본값은 기존 값 유지)
  app.image.server-url=${APP_IMAGE_SERVER_URL:http://localhost:8080}
  ```
- **주의사항**:
  - OAuth2 리다이렉트 URI와 이미지 서버 URL은 환경 변수로 관리하므로 재빌드 없이 변경 가능합니다.
  - 환경 변수가 설정되지 않으면 기본값이 사용됩니다.
  - 기존 설정은 주석 처리하거나 백업 후 수정합니다.

---

### Step 2: 빌드 파일 생성 (Jar 파일 추출)

#### 2-1. Gradle 빌드 실행
- **작업 내용**:
  - 도커 이미지에 넣을 실행 파일을 생성합니다.
  - 프로젝트 루트 폴더에서 빌드 명령어를 실행합니다.
- **실행 명령어**:
  ```bash
  ./gradlew :service:cmarket:clean :service:cmarket:bootJar
  ```
- **결과물 위치**:
  - `service/cmarket/build/libs/cmarket-0.0.1-SNAPSHOT.jar`
- **확인 사항**:
  - 빌드가 성공적으로 완료되었는지 확인
  - 생성된 jar 파일이 존재하는지 확인

---

### Step 3: Dockerfile 작성

#### 3-1. Dockerfile 생성
- **작업 내용**:
  - 프로젝트 루트 폴더에 `Dockerfile` 파일을 생성합니다.
  - Java 21 기반 이미지를 사용합니다 (프로젝트가 Java 21을 사용하므로).
  - 멀티 아키텍처 지원을 위해 플랫폼을 명시합니다 (Mac M1/M2 → Linux 호환).
  - 보안을 위해 non-root 사용자로 실행하도록 설정합니다.
  - 빌드된 jar 파일을 컨테이너 내부로 복사합니다.
  - H2 데이터 및 이미지 업로드용 폴더를 생성하고 권한을 설정합니다.
- **파일 위치**:
  - `/Users/jinioh/Documents/project/cmarket_api/Dockerfile`
- **파일 내용**:
  ```dockerfile
  # 멀티 아키텍처 지원 (Mac M1/M2 → Linux)
  FROM --platform=linux/amd64 eclipse-temurin:21-jdk-slim
  
  WORKDIR /app
  
  # 보안을 위한 non-root 사용자 생성
  RUN addgroup --system spring && adduser --system spring --ingroup spring
  
  # Healthcheck를 위한 wget 설치
  RUN apt-get update && apt-get install -y wget && rm -rf /var/lib/apt/lists/*
  
  # 빌드된 jar 파일을 컨테이너 내부로 복사
  COPY service/cmarket/build/libs/cmarket-0.0.1-SNAPSHOT.jar app.jar
  
  # H2 데이터 및 이미지 업로드용 폴더 생성 및 권한 설정
  RUN mkdir -p /data/uploads/images && \
      chown -R spring:spring /data && \
      chown -R spring:spring /app
  
  # non-root 사용자로 전환
  USER spring:spring
  
  # 포트 노출 (Spring Boot 기본 포트)
  EXPOSE 8080
  
  ENTRYPOINT ["java", "-jar", "app.jar"]
  ```
- **주의사항**:
  - Java 버전은 프로젝트의 `build.gradle`에서 확인한 Java 21을 사용합니다.
  - `eclipse-temurin`은 OpenJDK의 공식 배포판입니다.
  - `--platform=linux/amd64` 옵션으로 Mac M1/M2에서 빌드해도 Linux 서버에서 실행 가능합니다.
  - non-root 사용자(`spring`)로 실행하여 보안을 강화합니다.

---

### Step 4: Docker Compose 설정 파일 작성

#### 4-1. docker-compose.yml 생성
- **작업 내용**:
  - 프로젝트 루트 폴더에 `docker-compose.yml` 파일을 생성합니다.
  - Spring Boot 애플리케이션, Redis, Nginx Proxy Manager를 포함합니다.
  - 볼륨 마운트를 설정하여 데이터 영속성을 보장합니다.
  - Healthcheck를 추가하여 서비스 의존성을 안정적으로 관리합니다.
  - 환경 변수를 통해 OAuth2 및 이미지 URL을 관리합니다.
- **파일 위치**:
  - `/Users/jinioh/Documents/project/cmarket_api/docker-compose.yml`
- **파일 내용**:
  ```yaml
  version: '3.8'

  services:
    # 1. API 서버
    app:
      build: .
      container_name: cmarket-api
      restart: always
      depends_on:
        redis:
          condition: service_healthy
      volumes:
        - ./h2data:/data
        - ./uploads:/data/uploads
      environment:
        - SPRING_PROFILES_ACTIVE=prod
        # OAuth2 및 이미지 URL은 환경 변수로 관리 (도메인 설정 후 수정)
        - OAUTH2_REDIRECT_URI=${OAUTH2_REDIRECT_URI:-http://localhost:5173/oauth-redirect}
        - APP_IMAGE_SERVER_URL=${APP_IMAGE_SERVER_URL:-http://localhost:8080}
      healthcheck:
        # Actuator health 엔드포인트를 사용 (Dockerfile에서 wget 설치)
        # 대안: TCP 포트 체크 사용 시 아래 주석 처리된 방법 사용
        test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
        # 대안 (TCP 포트 체크): test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
        interval: 30s
        timeout: 10s
        retries: 3
        start_period: 40s
      networks:
        - cmarket-network

    # 2. Redis
    redis:
      image: redis:latest
      container_name: cmarket-redis
      restart: always
      volumes:
        - redis-data:/data
      healthcheck:
        test: ["CMD", "redis-cli", "ping"]
        interval: 10s
        timeout: 3s
        retries: 3
      networks:
        - cmarket-network

    # 3. Nginx + SSL 관리 도구 (Nginx Proxy Manager)
    proxy:
      image: 'jc21/nginx-proxy-manager:latest'
      container_name: cmarket-proxy
      restart: always
      ports:
        - '80:80'   # HTTP
        - '443:443' # HTTPS
        - '81:81'   # 관리자 UI용 포트
      volumes:
        - ./proxy/data:/data
        - ./proxy/letsencrypt:/etc/letsencrypt
      depends_on:
        app:
          condition: service_healthy
      networks:
        - cmarket-network

  volumes:
    redis-data:

  networks:
    cmarket-network:
      driver: bridge
  ```
- **주의사항**:
  - `h2data` 폴더는 H2 데이터베이스 파일을 저장합니다.
  - `uploads` 폴더는 이미지 업로드 파일을 저장합니다.
  - `proxy` 폴더는 Nginx Proxy Manager의 설정과 SSL 인증서를 저장합니다.
  - 네트워크를 별도로 구성하여 컨테이너 간 통신을 관리합니다.
  - Healthcheck를 통해 서비스 간 의존성을 안정적으로 관리합니다.
  - OAuth2 및 이미지 URL은 환경 변수로 관리하여 재빌드 없이 변경 가능합니다.

---

### Step 5: 서버 실행 및 도메인 연결

#### 5-1. 볼륨 폴더 생성 및 권한 설정
- **작업 내용**:
  - H2 데이터베이스와 이미지 업로드를 위한 볼륨 폴더를 생성하고 권한을 설정합니다.
  - 도커 볼륨 마운트 시 권한 문제를 방지합니다.
- **실행 명령어**:
  ```bash
  # 볼륨 폴더 생성
  mkdir -p h2data uploads/images proxy/data proxy/letsencrypt
  
  # 권한 설정 (H2 데이터베이스 쓰기 권한)
  chmod -R 777 h2data
  chmod -R 755 uploads
  chmod -R 755 proxy
  ```
- **주의사항**:
  - H2 데이터베이스는 파일 쓰기 권한이 필요하므로 `777` 권한을 설정합니다.
  - 운영 환경에서는 보안을 위해 더 엄격한 권한 설정을 고려할 수 있습니다.

#### 5-2. 컨테이너 실행
- **작업 내용**:
  - Docker Compose를 사용하여 모든 컨테이너를 실행합니다.
- **실행 명령어**:
  ```bash
  docker-compose up -d
  ```
- **확인 사항**:
  - 모든 컨테이너가 정상적으로 실행되었는지 확인
  ```bash
  docker-compose ps
  ```
  - 로그 확인
  ```bash
  docker-compose logs -f app
  ```
  - Healthcheck 상태 확인
  ```bash
  docker-compose ps
  # 모든 서비스의 상태가 "healthy"인지 확인
  ```

#### 5-3. 무료 도메인 준비 🔴 **수동 작업 필수**
- **⚠️ 이 작업은 반드시 수동으로 수행해야 합니다.**
- **작업 내용**:
  - Let's Encrypt에서 무료 SSL 인증서를 발급받기 위해 도메인이 필요합니다.
  - 무료 도메인 서비스 (예: Freenom, DuckDNS 등)를 사용하거나 기존 도메인을 사용합니다.
  - 도메인의 A 레코드를 서버의 공인 IP 주소로 설정합니다.
- **수동 작업 단계**:
  1. 도메인 서비스 제공업체에서 도메인 구매/등록
  2. DNS 관리 페이지 접속
  3. A 레코드 추가: 도메인 → 서버 공인 IP 주소
  4. DNS 전파 대기 (보통 몇 분~몇 시간)
- **주의사항**:
  - 도메인 DNS 설정이 완료될 때까지 시간이 걸릴 수 있습니다 (최대 24시간, 보통 몇 분~몇 시간).
  - DNS 전파 확인: `nslookup your-domain.com` 또는 `dig your-domain.com` 명령어로 확인

#### 5-4. Nginx Proxy Manager 설정 🔴 **수동 작업 필수**
- **⚠️ 이 작업은 반드시 수동으로 수행해야 합니다. (브라우저 작업)**
- **작업 내용**:
  - Nginx Proxy Manager 웹 UI에 접속하여 프록시 호스트를 설정합니다.
  - SSL 인증서를 발급받고 HTTPS를 활성화합니다.
- **수동 작업 단계**:
  1. **접속**: 브라우저에서 `http://서버IP:81` 또는 `http://localhost:81` 접속
  2. **로그인**: 기본 로그인 정보로 접속
     - Email: `admin@example.com`
     - Password: `changeme` (⚠️ 첫 로그인 시 반드시 변경 필요)
  3. **프록시 호스트 설정**:
     - `Proxy Hosts` 메뉴 클릭
     - `Add Proxy Host` 클릭
     - **Details 탭** 입력:
       - Domain Names: Step 5-3에서 설정한 도메인 (예: `api.yourdomain.com`)
       - Scheme: `http`
       - Forward Hostname / IP: `app` (Docker Compose 서비스 이름)
       - Forward Port: `8080`
       - Cache Assets: 체크 (선택사항)
       - Block Common Exploits: 체크 (권장)
       - Websockets Support: 체크 (채팅 기능 사용 시 필수)
     - **SSL 탭** 설정:
       - SSL Certificate: `Request a new SSL Certificate` 선택
       - Force SSL: 체크
       - HTTP/2 Support: 체크 (권장)
       - HSTS Enabled: 체크 (권장)
       - Email Address for Let's Encrypt: 본인 이메일 주소 입력
       - Agree to Let's Encrypt Terms of Service: 체크
     - `Save` 클릭
  4. **SSL 인증서 발급 대기**: 몇 분 소요될 수 있음
- **주의사항**:
  - SSL 인증서 발급에는 몇 분이 걸릴 수 있습니다.
  - 발급 실패 시 도메인 DNS 설정이 올바른지 확인하세요.
  - 발급 실패 시 Nginx Proxy Manager 로그에서 오류 메시지 확인

#### 5-5. 환경 변수 설정 (OAuth2 및 이미지 URL) 🔴 **수동 작업 필수**
- **⚠️ 이 작업은 반드시 수동으로 수행해야 합니다. (실제 도메인 값 입력 필요)**
- **작업 내용**:
  - Step 5-4에서 설정한 도메인에 맞춰 OAuth2 리다이렉트 URI와 이미지 서버 URL을 환경 변수로 설정합니다.
  - 환경 변수 파일(`.env`)을 생성하거나 `docker-compose.yml`을 수정합니다.
  - 재빌드 없이 컨테이너만 재시작하면 됩니다.
- **수동 작업 단계**:
  1. **.env 파일 생성** (방법 1 권장)
     - 파일 위치: `/Users/jinioh/Documents/project/cmarket_api/.env`
     - 파일 내용 (⚠️ `your-domain.com`을 Step 5-3에서 설정한 실제 도메인으로 변경):
       ```env
       # OAuth2 리다이렉트 URL (실제 도메인으로 변경 필요)
       OAUTH2_REDIRECT_URI=https://your-domain.com/oauth-redirect
       
       # 이미지 서버 URL (실제 도메인으로 변경 필요)
       APP_IMAGE_SERVER_URL=https://your-domain.com
       ```
  2. **또는 docker-compose.yml 직접 수정** (방법 2)
     - `docker-compose.yml`의 `app` 서비스 `environment` 섹션을 수정:
       ```yaml
       environment:
         - SPRING_PROFILES_ACTIVE=prod
         - OAUTH2_REDIRECT_URI=https://your-domain.com/oauth-redirect  # 실제 도메인으로 변경
         - APP_IMAGE_SERVER_URL=https://your-domain.com  # 실제 도메인으로 변경
       ```
  3. **컨테이너 재시작** (자동화 가능):
     ```bash
     # 환경 변수 변경 후 컨테이너만 재시작 (재빌드 불필요)
     docker-compose up -d app
     ```
- **주의사항**:
  - ⚠️ **반드시 실제 도메인 값으로 변경해야 합니다.** (`your-domain.com` 부분)
  - `.env` 파일은 `.gitignore`에 추가하여 Git에 커밋하지 않도록 합니다.
  - 환경 변수 방식으로 관리하므로 코드 수정 및 재빌드가 필요 없습니다.
  - 도메인 변경 시 `.env` 파일만 수정하고 컨테이너를 재시작하면 됩니다.

---

### Step 6: 배포 확인 및 테스트

#### 6-1. 서비스 동작 확인
- **작업 내용**:
  - API 서버가 정상적으로 동작하는지 확인합니다.
- **확인 방법**:
  1. Health Check 엔드포인트 호출 (있는 경우)
     ```bash
     curl https://your-domain.com/actuator/health
     ```
  2. API 엔드포인트 호출 테스트
     ```bash
     curl https://your-domain.com/api/health
     ```
  3. H2 Console 접속 확인 (개발 환경에서만)
     - `https://your-domain.com/h2-console`

#### 6-2. 데이터 영속성 확인
- **작업 내용**:
  - H2 데이터베이스와 이미지 파일이 볼륨에 저장되는지 확인합니다.
- **확인 방법**:
  ```bash
  # H2 데이터 확인
  ls -la ./h2data/
  
  # 업로드 이미지 확인
  ls -la ./uploads/images/
  ```

#### 6-3. Redis 연결 확인
- **작업 내용**:
  - Redis 컨테이너가 정상적으로 동작하고 애플리케이션과 연결되는지 확인합니다.
- **확인 방법**:
  ```bash
  # Redis 컨테이너 접속
  docker exec -it cmarket-redis redis-cli
  
  # Redis 명령어로 확인
  ping
  # PONG 응답이 오면 정상
  ```

---

## 추가 고려사항

### 보안 설정
- **JWT Secret Key**: 운영 환경에서는 반드시 강력한 Secret Key로 변경해야 합니다.
  - 환경 변수로 관리: `JWT_SECRET=${JWT_SECRET:your-secret-key}`
- **Redis Password**: 운영 환경에서는 Redis에 비밀번호를 설정하는 것을 권장합니다.
  - `docker-compose.yml`의 Redis 서비스에 `command: redis-server --requirepass ${REDIS_PASSWORD}` 추가
- **OAuth2 Client Secret**: Google OAuth2 Client Secret이 코드에 노출되어 있으므로, 환경 변수로 관리하는 것을 권장합니다.
  - `application.properties`에서 환경 변수로 변경: `spring.security.oauth2.client.registration.google.client-secret=${GOOGLE_CLIENT_SECRET}`
- **Non-root 사용자**: Dockerfile에서 non-root 사용자(`spring`)로 실행하여 보안을 강화합니다.
- **멀티 아키텍처 지원**: `--platform=linux/amd64` 옵션으로 크로스 플랫폼 빌드를 지원합니다.

### 환경 변수 관리
- **환경 변수 파일**: `.env` 파일을 생성하여 민감한 정보를 관리할 수 있습니다.
  - OAuth2 리다이렉트 URI와 이미지 서버 URL을 환경 변수로 관리하여 재빌드 없이 변경 가능합니다.
  - `.env` 파일은 `.gitignore`에 추가하여 Git에 커밋하지 않도록 합니다.
- **Docker Compose 환경 변수**: `docker-compose.yml`의 `environment` 섹션에 환경 변수를 추가할 수 있습니다.
- **보안**: 민감한 정보(비밀키, OAuth2 Client Secret 등)는 환경 변수로 관리하는 것을 강력히 권장합니다.

### 로그 관리
- **로그 볼륨 마운트**: 애플리케이션 로그를 호스트에 저장하려면 볼륨을 추가로 마운트할 수 있습니다.
- **로그 로테이션**: 장기 운영 시 로그 로테이션 설정을 고려해야 합니다.

### 백업 전략
- **H2 데이터베이스 백업**: `h2data` 폴더를 정기적으로 백업해야 합니다.
- **이미지 파일 백업**: `uploads` 폴더를 정기적으로 백업해야 합니다.

### 모니터링
- **Spring Boot Actuator**: 이미 의존성이 추가되어 있으므로, 모니터링 엔드포인트를 활용할 수 있습니다.
- **컨테이너 모니터링**: `docker stats` 명령어로 컨테이너 리소스 사용량을 확인할 수 있습니다.

---

## 트러블슈팅

### 컨테이너가 시작되지 않는 경우
1. 로그 확인: `docker-compose logs app`
2. 포트 충돌 확인: 다른 서비스가 80, 443, 8080 포트를 사용하고 있는지 확인
3. 볼륨 권한 확인: `h2data`, `uploads`, `proxy` 폴더의 권한 확인
   - H2 데이터베이스 쓰기 권한 문제 시: `chmod -R 777 h2data`
   - 이미지 업로드 권한 문제 시: `chmod -R 755 uploads`
4. Healthcheck 실패: `docker-compose ps`로 healthcheck 상태 확인
   - Actuator 엔드포인트가 활성화되어 있는지 확인 (`/actuator/health`)
   - Healthcheck 명령어가 컨테이너 내부에서 실행 가능한지 확인
   - wget이 설치되어 있는지 확인 (Dockerfile에서 설치됨)
   - 대안: TCP 포트 체크로 변경 가능 (`nc -z localhost 8080`)

### SSL 인증서 발급 실패
1. 도메인 DNS 설정 확인: A 레코드가 올바르게 설정되었는지 확인
2. 방화벽 확인: 80, 443 포트가 열려있는지 확인
3. Let's Encrypt 제한 확인: 같은 도메인에 대한 요청이 너무 많으면 일시적으로 차단될 수 있음

### Redis 연결 실패
1. Redis 컨테이너 상태 확인: `docker-compose ps redis`
2. 네트워크 확인: 같은 네트워크에 있는지 확인
3. 호스트명 확인: `application.properties`에서 `spring.data.redis.host=redis`로 설정되어 있는지 확인

---

## 완료 체크리스트

### 자동화 가능한 작업
- [ ] Step 1: application.properties 수정 완료
- [ ] Step 2: Jar 파일 빌드 완료
- [ ] Step 3: Dockerfile 작성 완료
- [ ] Step 4: docker-compose.yml 작성 완료
- [ ] Step 5-1: 볼륨 폴더 생성 및 권한 설정 완료
- [ ] Step 5-2: 컨테이너 실행 완료
- [ ] Step 6-1: 서비스 동작 확인 완료
- [ ] Step 6-2: 데이터 영속성 확인 완료
- [ ] Step 6-3: Redis 연결 확인 완료

### 🔴 수동 작업 필수
- [ ] Step 5-3: 도메인 준비 완료 (도메인 구매/등록 및 DNS A 레코드 설정)
- [ ] Step 5-4: Nginx Proxy Manager 설정 완료 (웹 UI에서 프록시 호스트 및 SSL 설정)
- [ ] Step 5-5: 환경 변수 설정 완료 (실제 도메인 값으로 .env 파일 수정)

---

## 참고 자료

- [Docker 공식 문서](https://docs.docker.com/)
- [Docker Compose 공식 문서](https://docs.docker.com/compose/)
- [Nginx Proxy Manager 공식 문서](https://nginxproxymanager.com/)
- [Let's Encrypt 공식 문서](https://letsencrypt.org/)
- [Spring Boot Docker 가이드](https://spring.io/guides/gs/spring-boot-docker/)
