# S3 파일 업로드 마이그레이션 할일

> 로컬 파일 저장소 → AWS S3 마이그레이션 작업 목록

---

## 개요

현재 파일 업로드 API는 로컬 파일 시스템(`uploads/images`)에 파일을 저장하고 있습니다.
이를 AWS S3로 변경하여 확장성과 안정성을 향상시킵니다.

**현재 구조:**
- `ImageController`: 이미지 업로드/조회 컨트롤러
- `ImageUploadService`: 로컬 파일 시스템에 저장하는 서비스
- 저장 경로: `uploads/images/user/{userId}/{yyyy}/{MM}/{dd}/{uuid}.{ext}`
- 조회 방식: GET `/api/images/**`로 로컬 파일을 읽어서 반환

**변경 후 구조:**
- `ImageUploadService`: S3에 업로드하고 S3 URL 반환
- `ImageController`: 이미지 조회는 S3 URL로 리다이렉트 또는 프록시

---

## 사용자가 직접 해야 할 작업

### Step 1: AWS 인프라 설정

#### 1-1. AWS 계정 및 S3 버킷 생성
- **작업 내용**:
  - AWS 콘솔에 로그인
  - S3 서비스로 이동
  - 새 버킷 생성
    - 버킷 이름: 예) `cmarket-images` (전역적으로 고유해야 함)
    - 리전: 예) `ap-northeast-2` (서울)
    - 퍼블릭 액세스 차단 설정: **비활성화** (이미지 조회를 위해 퍼블릭 읽기 필요)
    - 버전 관리: 필요 시 활성화
    - 암호화: 기본값 또는 SSE-S3 사용
  - 버킷 생성 완료 확인

#### 1-2. IAM 사용자/역할 생성 및 권한 설정
- **작업 내용**:
  - IAM 서비스로 이동
  - 새 사용자 생성 또는 기존 사용자 선택
  - S3 접근 권한 정책 생성/할당:
    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "s3:PutObject",
            "s3:GetObject",
            "s3:DeleteObject",
            "s3:ListBucket",
            "s3:PutBucketPolicy"
          ],
          "Resource": [
            "arn:aws:s3:::cmarket-images",
            "arn:aws:s3:::cmarket-images/*"
          ]
        }
      ]
    }
    ```
  - ⚠️ **중요**: `s3:PutBucketPolicy` 권한이 필요합니다. 이 권한이 없으면 버킷 정책을 저장할 수 없습니다.
  - 액세스 키 ID와 시크릿 액세스 키 생성 및 안전하게 보관
  - ⚠️ **중요**: 시크릿 액세스 키는 한 번만 표시되므로 반드시 저장

#### 1-3. S3 버킷 CORS 설정
- **작업 내용**:
  - S3 버킷 선택 → 권한 탭 → CORS(교차 출처 리소스 공유) 섹션
  - CORS 구성 편집:
    ```json
    [
      {
        "AllowedHeaders": ["*"],
        "AllowedMethods": ["GET", "PUT", "POST", "DELETE", "HEAD"],
        "AllowedOrigins": [
          "http://localhost:5173",
          "https://your-production-domain.com"
        ],
        "ExposeHeaders": ["ETag"],
        "MaxAgeSeconds": 3000
      }
    ]
    ```
  - 운영 환경 도메인에 맞게 `AllowedOrigins` 수정

#### 1-4. S3 버킷 퍼블릭 액세스 차단 설정 해제
- **작업 내용**:
  - S3 버킷 선택 → 권한 탭 → 퍼블릭 액세스 차단 설정(버킷 설정) 섹션
  - "편집" 버튼 클릭
  - ⚠️ **중요**: 버킷 정책에서 퍼블릭 읽기를 허용하려면 다음 설정을 **반드시 해제**해야 합니다:
    - ✅ **"새 퍼블릭 버킷 정책을 차단" (Block public bucket policies)** → **체크 해제** ⚠️ 필수
      - 이 설정이 활성화되어 있으면 퍼블릭 버킷 정책을 저장할 수 없습니다
    - ✅ **"퍼블릭 버킷 정책을 통해 부여된 퍼블릭 및 크로스 계정 액세스를 차단" (Block public and cross-account access to buckets and objects through public bucket policies)** → **체크 해제** ⚠️ 필수
    - 나머지 두 항목은 체크 상태 유지 가능:
      - "새 퍼블릭 ACL 및 퍼블릭 객체를 통해 부여된 액세스를 차단" (Block public access to buckets and objects granted through new public ACLs)
      - "퍼블릭 ACL을 통해 부여된 크로스 계정 액세스를 차단" (Block public and cross-account access to buckets and objects through any public ACLs)
  - "변경 사항 저장" 클릭
  - 경고 메시지 확인 후 "퍼블릭 액세스 차단 설정 편집 확인" 입력하여 확인
  - ⚠️ **이 단계를 완료하지 않으면 Step 1-5에서 버킷 정책을 저장할 수 없습니다!**

#### 1-5. S3 버킷 퍼블릭 읽기 정책 설정
- **작업 내용**:
  - S3 버킷 선택 → 권한 탭 → 버킷 정책 편집
  - 퍼블릭 읽기 정책 추가:
    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "PublicReadGetObject",
          "Effect": "Allow",
          "Principal": "*",
          "Action": "s3:GetObject",
          "Resource": "arn:aws:s3:::cmarket-images/*"
        }
      ]
    }
    ```
  - "저장" 클릭
  - ⚠️ **오류 발생 시 해결 방법**:
    - **오류 1**: `"User: arn:aws:iam::...:root is not authorized to perform: s3:PutBucketPolicy on resource: arn:aws:s3:::cmarket-images because public policies are prevented by the BlockPublicPolicy setting in S3 Block Public Access."`
      - **원인**: S3 Block Public Access 설정에서 "새 퍼블릭 버킷 정책을 차단" (BlockPublicPolicy) 설정이 활성화되어 있음
      - **해결**: Step 1-4로 돌아가서 "새 퍼블릭 버킷 정책을 차단" 설정을 **반드시 체크 해제**한 후 다시 시도
      - 확인 방법: S3 버킷 → 권한 탭 → 퍼블릭 액세스 차단 설정에서 해당 항목이 체크 해제되어 있는지 확인
    - **오류 2**: "버킷 정책을 편집할 권한이 없습니다" 또는 `"User: ... is not authorized to perform: s3:PutBucketPolicy"`
      - 해결: IAM 사용자에게 `s3:PutBucketPolicy` 권한이 있는지 확인 (Step 1-2 참조)
      - 또는 루트 계정으로 로그인하여 버킷 정책 설정
    - **오류 3**: "퍼블릭 액세스 차단 설정과 충돌"
      - 해결: Step 1-4에서 퍼블릭 액세스 차단 설정을 먼저 해제해야 합니다
  - ⚠️ **보안 고려사항**: 
    - 모든 이미지를 퍼블릭으로 공개하는 것이므로, 필요 시 사전 서명된 URL 방식으로 변경 고려
    - 또는 CloudFront를 사용하여 접근 제어 강화 고려

#### 1-6. AWS 자격 증명 설정
- **작업 내용**:
  - **방법 1: 환경 변수 설정** (권장)
    - 로컬 개발: `.env` 파일 또는 IDE 환경 변수 설정
      ```
      AWS_ACCESS_KEY_ID=your-access-key-id
      AWS_SECRET_ACCESS_KEY=your-secret-access-key
      AWS_REGION=ap-northeast-2
      ```
    - 운영 환경: EC2 인스턴스 프로필 또는 환경 변수로 설정
  - **방법 2: AWS 자격 증명 파일** (로컬 개발용)
    - `~/.aws/credentials` 파일 생성:
      ```
      [default]
      aws_access_key_id=your-access-key-id
      aws_secret_access_key=your-secret-access-key
      ```
    - `~/.aws/config` 파일 생성:
      ```
      [default]
      region=ap-northeast-2
      ```
  - ⚠️ **보안 주의사항**:
    - 자격 증명 정보는 절대 Git에 커밋하지 않기
    - `.gitignore`에 `.env`, `~/.aws/credentials` 추가 확인

---

## AI에게 위임할 수 있는 작업

### Step 2: 의존성 추가

#### 2-1. AWS SDK 의존성 추가
- **작업 내용**:
  - `service/cmarket/build.gradle`에 AWS SDK S3 의존성 추가
  - Spring Cloud AWS 또는 AWS SDK for Java v2 사용
  - **권장**: AWS SDK for Java v2 (더 가볍고 최신)
- **출력물**:
  - `service/cmarket/build.gradle` 수정

---

### Step 3: S3 서비스 구현

#### 3-1. S3 업로드 서비스 생성
- **작업 내용**:
  - `S3ImageUploadService` 또는 기존 `ImageUploadService` 수정
  - S3 클라이언트 초기화
  - 파일 업로드 로직 구현
    - 기존 경로 구조 유지: `user/{userId}/{yyyy}/{MM}/{dd}/{uuid}.{ext}`
    - S3 키(파일 경로) 생성
    - `PutObjectRequest`로 업로드
    - S3 URL 반환: `https://{bucket-name}.s3.{region}.amazonaws.com/{key}`
  - 파일 유효성 검증 로직은 기존과 동일하게 유지
- **출력물**:
  - `service/cmarket/src/main/java/org/cmarket/cmarket/web/product/service/ImageUploadService.java` 수정
  - 또는 `S3ImageUploadService.java` 새로 생성 (기존 서비스와 교체)

#### 3-2. S3 설정 프로퍼티 추가
- **작업 내용**:
  - `application.properties`에 S3 관련 설정 추가:
    - `aws.s3.bucket-name`: S3 버킷 이름
    - `aws.s3.region`: 리전 (기본값: ap-northeast-2)
    - `aws.s3.access-key`: 액세스 키 (환경 변수로 주입)
    - `aws.s3.secret-key`: 시크릿 키 (환경 변수로 주입)
  - 기존 `app.image.upload-dir` 설정은 제거 또는 주석 처리
- **출력물**:
  - `service/cmarket/src/main/resources/application.properties` 수정
  - `service/cmarket/src/main/resources/application-prod.properties` 수정 (운영 환경용)

---

### Step 4: 컨트롤러 수정

#### 4-1. 이미지 조회 로직 변경
- **작업 내용**:
  - **옵션 1: S3 URL 직접 반환** (권장)
    - 업로드 시 S3 URL을 반환하므로, 조회 API는 필요 없음
    - `ImageController.getImage()` 메서드 제거 또는 deprecated 처리
    - 프론트엔드에서 S3 URL을 직접 사용
  - **옵션 2: 프록시 방식 유지**
    - S3에서 파일을 다운로드하여 응답으로 반환
    - 기존 API 경로 유지 (`/api/images/**`)
    - S3 클라이언트로 `GetObjectRequest` 사용
  - **옵션 3: 리다이렉트**
    - S3 URL로 302 리다이렉트
- **출력물**:
  - `service/cmarket/src/main/java/org/cmarket/cmarket/web/common/ImageController.java` 수정

---

### Step 5: 기존 파일 마이그레이션 (선택사항)

#### 5-1. 기존 로컬 파일을 S3로 이전
- **작업 내용**:
  - 로컬 `uploads/images` 디렉토리의 기존 파일들을 S3로 업로드하는 스크립트 작성
  - 배치 작업으로 실행
  - 데이터베이스의 이미지 URL 업데이트 (필요 시)
- **출력물**:
  - 마이그레이션 스크립트 (선택사항)

---

### Step 6: 테스트 및 검증

#### 6-1. 단위 테스트 작성
- **작업 내용**:
  - S3 업로드 서비스 테스트
  - Mock S3 클라이언트 사용 또는 Testcontainers LocalStack 사용
- **출력물**:
  - 테스트 코드 작성

#### 6-2. 통합 테스트
- **작업 내용**:
  - 실제 S3 버킷에 테스트 이미지 업로드
  - 이미지 조회 API 테스트
  - 파일 크기/형식 검증 테스트
  - 에러 처리 테스트 (S3 접근 실패 등)
- **검증 항목**:
  - ✅ 이미지 업로드 성공
  - ✅ S3 URL 반환 확인
  - ✅ 이미지 접근 가능 확인
  - ✅ 파일 유효성 검증 동작 확인
  - ✅ 에러 처리 동작 확인

---

## 구현 순서 요약

1. **사용자 작업**: AWS 인프라 설정 (Step 1)
   - S3 버킷 생성
   - IAM 권한 설정
   - CORS 설정
   - 자격 증명 설정

2. **AI 작업**: 의존성 추가 (Step 2)

3. **AI 작업**: S3 서비스 구현 (Step 3)

4. **AI 작업**: 컨트롤러 수정 (Step 4)

5. **AI 작업**: 테스트 및 검증 (Step 6)

6. **선택사항**: 기존 파일 마이그레이션 (Step 5)

---

## 주의사항

### 보안
- AWS 자격 증명은 절대 코드에 하드코딩하지 않기
- 환경 변수 또는 AWS 자격 증명 파일 사용
- `.gitignore`에 자격 증명 관련 파일 추가 확인

### 비용
- S3 스토리지 비용: GB당 월 요금
- 데이터 전송 비용: PUT/GET 요청 비용
- CloudFront 사용 시 추가 비용 발생 가능

### 성능
- S3 직접 접근: 빠른 속도, CDN 없이도 충분
- CloudFront 사용: 전 세계 엣지 로케이션으로 더 빠른 속도 (추가 비용)

### 호환성
- 기존 API 응답 형식 유지 (URL만 변경)
- 프론트엔드 수정 최소화

---

## 참고 자료

- [AWS S3 Java SDK v2 문서](https://docs.aws.amazon.com/sdk-for-java/latest/developer-guide/home.html)
- [Spring Cloud AWS 문서](https://spring.io/projects/spring-cloud-aws)
- [S3 버킷 정책 예제](https://docs.aws.amazon.com/AmazonS3/latest/userguide/example-bucket-policies.html)

